<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
        <title>–ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ –∏–∑ –ø–∏—Å–µ–º</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="email-parser.js"></script>
        <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-content upload-mode" id="mainContent">
        <div class="detailed-reports">
            <div id="reports" class="report"></div>
        </div>
        <div class="upload-panel" id="uploadPanel">
            <div class="drop-zone" id="dropZone" onclick="document.getElementById('msgFiles').click()">
                <div class="main-text">üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ 9 —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                <input type="file" id="msgFiles" multiple accept=".msg" style="display:none;">
            </div>
        </div>
        <div class="summary-panel">
            <!-- –§–æ—Ä–º–∞ –ø–∏—Å—å–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div class="email-form-area">
                <div class="email-form">
                    <div class="form-group">
                        <label for="emailRecipients">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:</label>
                        <textarea id="emailRecipients" placeholder="–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ MSG —Ñ–∞–π–ª–æ–≤..." ></textarea>
                    </div>
                    <div class="form-group">
                        <label for="emailSubject">–¢–µ–º–∞:</label>
                        <input type="text" id="emailSubject" value="" >
                    </div>
                    <div class="form-group">
                        <label for="emailBody">–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞:</label>
                        <textarea id="emailBody" placeholder="–û—Ç—á–µ—Ç –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤..." ></textarea>
                    </div>
                    <div class="form-group">
                        <label for="emailSignature">–ü–æ–¥–ø–∏—Å—å:</label>
                        <textarea id="emailSignature" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –ø–æ–¥–ø–∏—Å—å..."></textarea>
                    </div>
                    <button class="send-email-button" id="sendEmailButton" onclick="openEmailClient()" disabled>üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loading">
        <!-- –í–∏–¥–µ–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∞–ª–µ—Ä—Ç–æ–≤ -->
    <div class="alert-container" id="alertContainer"></div>
    
    <script>
        // –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–∞–º–∏
        class AlertManager {
            constructor() {
                this.container = document.getElementById('alertContainer');
                this.alertCounter = 0;
            }
            
            showAlert(type, title, message, details = null) {
                this.alertCounter++;
                const alertId = `alert-${this.alertCounter}`;
                
                const alertElement = document.createElement('div');
                alertElement.className = `alert-item alert-${type}`;
                alertElement.id = alertId;
                
                alertElement.innerHTML = `
                    <div class="alert-header">
                        <h4 class="alert-title">${this.getIcon(type)} ${title}</h4>
                        <button class="alert-close" onclick="alertManager.closeAlert('${alertId}')">&times;</button>
                    </div>
                    <p class="alert-message">${message}</p>
                    ${details ? `<div class="alert-details">${details}</div>` : ''}
                `;
                
                this.container.appendChild(alertElement);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ª–µ—Ä—Ç–æ–≤ (–º–∞–∫—Å–∏–º—É–º 8)
                const alerts = this.container.querySelectorAll('.alert-item');
                if (alerts.length > 8) {
                    this.closeAlert(alerts[0].id);
                }
                
                return alertId;
            }
            
            closeAlert(alertId) {
                const alert = document.getElementById(alertId);
                if (alert && !alert.classList.contains('removing')) {
                    alert.classList.add('removing');
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 300);
                }
            }
            
            getIcon(type) {
                const icons = {
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'info': '‚ÑπÔ∏è'
                };
                return icons[type] || '‚ÑπÔ∏è';
            }
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            warning(title, message, details) {
                return this.showAlert('warning', title, message, details);
            }
            
            error(title, message, details) {
                return this.showAlert('error', title, message, details);
            }
            
            info(title, message, details) {
                return this.showAlert('info', title, message, details);
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∞–ª–µ—Ä—Ç–æ–≤
        const alertManager = new AlertManager();
        
        // –°–∏—Å—Ç–µ–º–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –≥–∏—Ñ–æ–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–ü–†–û–°–¢–û–ô –ø–æ–¥—Ö–æ–¥ –∫–∞–∫ –≤ —Ç–µ—Å—Ç–µ)
        class LoadingGifManager {
            constructor() {
                // –ù–∞–±–æ—Ä WebM —Ñ–∞–π–ª–æ–≤ (–∫–∞–∫ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ñ–∞–π–ª–µ)
                this.gifs = [
                    'webm/aesthetic_possum_by_fstikbot_agadywoaajwomug_AgADYWoAAjwomUg.webm',
                    'webm/kitties4bynorufx_by_fstikbot_agad2bsaapplaus_AgAD2BsAApPLAUs.webm',
                    'webm/kitties4bynorufx_by_fstikbot_agadzrwaanlkaafl_AgADzRwAAnLkAAFL.webm',
                    'webm/sadcattwitch_by_fstikbot_agadq2gaagdgsug_AgADq2gAAgdGSUg.webm',
                    'webm/tinycatss_agad03maanpukek_AgAD03MAAnpuKEk.webm',
                    'webm/tinycatss_agadg2kaarzfseg_AgADg2kAArZFsEg.webm',
                    'webm/vikostvspack_agad2zsaamelaafk_AgAD2zsAAmeLAAFK.webm',
                    'webm/vikostvspack_agad6d4aatdsweo_AgAD6D4AAtdsWEo.webm',
                    'webm/vikostvspack_agadfgcaapzjues_AgADfGcAApzJUEs.webm',
                    'webm/vikostvspack_agadndwaavuqieo_AgADNDwAAvuqIEo.webm',
                    'webm/vikostvspack_agadxweaamgokeg_AgADXWEAAmGoKEg.webm',
                    'webm/whitehamsterwow_agadbn8aajrngus_AgADBn8AAjRNGUs.webm'
                ];
                
                this.loadingElement = document.getElementById('loading');
                this.isShowing = false;
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ –≤–∏–¥–µ–æ
            show() {
                if (this.isShowing) {
                    return;
                }
                this.isShowing = true;
                
                // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –≤–∏–¥–µ–æ
                const randomIndex = Math.floor(Math.random() * this.gifs.length);
                const selectedVideo = this.gifs[randomIndex];
                
                // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ JavaScript
                const video = document.createElement('video');
                video.className = 'loading-gif';
                video.autoplay = true;
                video.loop = true;
                video.muted = true;
                video.playsInline = true;
                video.style.cssText = 'max-width:300px;height:auto;display:block;margin:20px auto;border-radius:8px;';
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
                video.src = selectedVideo;
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
                this.loadingElement.innerHTML = '';
                this.loadingElement.appendChild(video);
                this.loadingElement.style.display = 'block';
                
                // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞
                const startVideo = () => {
                    if (video.readyState >= 3) { // HAVE_FUTURE_DATA
                        video.play().catch(e => {
                            console.log('Autoplay blocked, trying manual start:', e);
                            // Fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
                            this.loadingElement.innerHTML = `
                                <div style="text-align:center;color:#4c6ef5;font-size:18px;font-weight:bold;padding:20px;">
                                    ‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...
                                </div>
                            `;
                        });
                    }
                };
                
                // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                video.addEventListener('canplay', startVideo, { once: true });
                video.addEventListener('loadeddata', startVideo, { once: true });
                video.addEventListener('loadedmetadata', startVideo, { once: true });
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
                setTimeout(() => {
                    if (video.paused) {
                        video.play().catch(() => {});
                    }
                }, 50);
                
                setTimeout(() => {
                    if (video.paused) {
                        video.play().catch(() => {});
                    }
                }, 200);
                
                setTimeout(() => {
                    if (video.paused) {
                        video.play().catch(() => {});
                    }
                }, 500);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                video.addEventListener('error', () => {
                    console.log('Video loading error for:', selectedVideo);
                    this.onError();
                }, { once: true });
                
                // –§–∏–Ω–∞–ª—å–Ω—ã–π fallback —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    if (video.paused || video.readyState === 0) {
                        console.log('Video failed to start, showing text fallback');
                        this.onError();
                    }
                }, 1000);
            }
            
            // –°–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ
            hide() {
                if (!this.isShowing) {
                    return;
                }
                
                this.isShowing = false;
                this.loadingElement.style.display = 'none';
                this.loadingElement.innerHTML = '';
            }
            
            // Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ
            onError() {
                if (!this.isShowing) {
                    return;
                }
                
                console.log('LoadingGifManager: Switching to text fallback due to video error');
                
                this.loadingElement.innerHTML = `
                    <div style="color: #4c6ef5; font-size: 18px; font-weight: bold; text-align: center; padding: 20px;">
                        ‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...
                        <br>
                        <div style="font-size: 12px; color: #888; margin-top: 10px;">
                            (–ê–Ω–∏–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
                        </div>
                    </div>
                `;
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≥–∏—Ñ–æ–∫
        const loadingGifManager = new LoadingGifManager();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–∏—Å—å–º–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—É –ø–∏—Å—å–º–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∞—Ç–æ–π
            const now = new Date();
            
            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –¥–æ 8 —É—Ç—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
            const reportDate = now.getHours() < 8 
                ? new Date(now.getTime() - 24 * 60 * 60 * 1000) // –í—á–µ—Ä–∞
                : now; // –°–µ–≥–æ–¥–Ω—è
            
            const dateStr = reportDate.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
            
            document.getElementById('emailSubject').value = `WMS –æ—à–∏–±–∫–∏ –∑–∞ —Å—É—Ç–∫–∏ –æ—Ç ${dateStr}`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ø–∏—Å—å –∏–∑ –∫—ç—à–∞
            loadSignatureFromCache();
            
            // –ü—Ä–æ—Å—Ç–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏
            const signatureElement = document.getElementById('emailSignature');
            signatureElement.addEventListener('input', function() {
                saveSignatureToCache();
            });
        });

        // –ü–∞—Ä—Å–µ—Ä MSG —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è Excel –≤–ª–æ–∂–µ–Ω–∏–π
        function parseMSGFile(arrayBuffer) {
            const view = new DataView(arrayBuffer);
            const attachments = [];
            
            // –ü–æ–∏—Å–∫ ZIP —Å–∏–≥–Ω–∞—Ç—É—Ä (–æ—Å–Ω–æ–≤–∞ XLSX —Ñ–∞–π–ª–æ–≤)
            const zipSignature = [0x50, 0x4B, 0x03, 0x04];
            const maxSearch = Math.min(view.byteLength, 10000000); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∏—Å–∫ 10MB
            let foundPositions = [];
            
            for (let i = 0; i < maxSearch - 4; i += 1) {
                if (view.getUint8(i) === zipSignature[0] &&
                    view.getUint8(i + 1) === zipSignature[1] &&
                    view.getUint8(i + 2) === zipSignature[2] &&
                    view.getUint8(i + 3) === zipSignature[3]) {
                    foundPositions.push(i);
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
            for (const startPos of foundPositions.slice(0, 5)) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ 5 –ø–æ–∑–∏—Ü–∏–π
                try {
                    const remainingBytes = view.byteLength - startPos;
                    const testSizes = [
                        Math.min(1000000, remainingBytes),  // 1MB 
                        Math.min(2000000, remainingBytes),  // 2MB
                        remainingBytes  // –í–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫
                    ];
                    
                    for (const testSize of testSizes) {
                        if (testSize < 1000) continue;
                        
                        try {
                            const excelData = arrayBuffer.slice(startPos, startPos + testSize);
                            
                            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ Excel –º–∞—Ä–∫–µ—Ä–æ–≤
                            const preCheck = new Uint8Array(excelData.slice(0, Math.min(1000, excelData.byteLength)));
                            const preCheckStr = new TextDecoder('utf-8', {fatal: false}).decode(preCheck);
                            
                            if (preCheckStr.includes('xl/') || preCheckStr.includes('workbook') || 
                                preCheckStr.includes('[Content_Types]')) {
                                
                                const testWorkbook = XLSX.read(excelData, {
                                    type: 'array', 
                                    bookVBA: false, 
                                    bookProps: false,
                                    cellStyles: false
                                });
                                
                                if (testWorkbook.SheetNames && testWorkbook.SheetNames.length > 0) {
                                    attachments.push({
                                        fileName: `excel_${attachments.length + 1}.xlsx`,
                                        content: excelData,
                                        size: testSize,
                                        position: startPos
                                    });
                                    break;
                                }
                            }
                        } catch (testError) {
                            continue;
                        }
                    }
                } catch (e) {
                    continue;
                }
                
                if (attachments.length >= 1) break; // –û–¥–∏–Ω —Ñ–∞–π–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
            }
            
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ Excel –º–∞—Ä–∫–µ—Ä–∞–º (–µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
            if (attachments.length === 0) {
                const excelMarkers = ['xl/workbook.xml', 'xl/worksheets/', '[Content_Types].xml'];
                const blockSize = 4096;
                let foundMarkers = [];
                
                for (let i = 0; i < view.byteLength - blockSize; i += blockSize) {
                    try {
                        const block = arrayBuffer.slice(i, Math.min(i + blockSize, view.byteLength));
                        const blockStr = new TextDecoder('utf-8', {fatal: false}).decode(block);
                        
                        for (const marker of excelMarkers) {
                            if (blockStr.includes(marker)) {
                                foundMarkers.push(i);
                                break;
                            }
                        }
                        
                        if (foundMarkers.length >= 2) break;
                    } catch (e) {
                        continue;
                    }
                }
                
                // –ü–æ–∏—Å–∫ ZIP —Å–∏–≥–Ω–∞—Ç—É—Ä —Ä—è–¥–æ–º —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏
                for (const markerPos of foundMarkers) {
                    const searchStart = Math.max(0, markerPos - 51200); // 50KB –Ω–∞–∑–∞–¥
                    const searchEnd = Math.min(view.byteLength - 4, markerPos + 51200); // 50KB –≤–ø–µ—Ä–µ–¥
                    
                    for (let j = searchStart; j < searchEnd; j += 1) {
                        if (view.getUint8(j) === 0x50 && view.getUint8(j + 1) === 0x4B) {
                            try {
                                const remainingSize = view.byteLength - j;
                                const excelData = arrayBuffer.slice(j, j + Math.min(2000000, remainingSize));
                                const testWorkbook = XLSX.read(excelData, {type: 'array', bookVBA: false});
                                
                                if (testWorkbook.SheetNames && testWorkbook.SheetNames.length > 0) {
                                    attachments.push({
                                        fileName: `recovered_excel.xlsx`,
                                        content: excelData,
                                        size: excelData.byteLength,
                                        position: j
                                    });
                                    return { attachments };
                                }
                            } catch (e) {
                                continue;
                            }
                        }
                    }
                }
            }
            
            return { attachments };
        }

        // –§—É–Ω–∫—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫
        function categorizeErrors(errorRows) {
            let hasAlerts = false;
            let hasIgnored = false;
            
            if (!errorRows || errorRows.length === 0) {
                return 'clean';
            }
            
            for (const error of errorRows) {
                const nodeText = error.node || '';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–∑–µ–ª –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                if (nodeText.includes('–§–æ–Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ. –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è') || 
                    nodeText.includes('–û–±–º–µ–Ω.')) {
                    hasIgnored = true;
                } else {
                    // –õ—é–±–æ–π –¥—Ä—É–≥–æ–π —É–∑–µ–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–ª–µ—Ä—Ç–æ–º
                    hasAlerts = true;
                }
            }
            
            // –ê–ª–µ—Ä—Ç—ã –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏
            if (hasAlerts) {
                return 'alerts';
            } else if (hasIgnored) {
                return 'ignore';
            } else {
                return 'clean';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫—Ä–∞—Ç–∫–æ–≥–æ –æ—Ç—á—ë—Ç–∞
        function generateSummaryText(results) {
            const categories = {
                clean: [],
                ignore: [],
                alerts: []
            };
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            results.forEach(result => {
                if (result.status === 'success') {
                    const category = categorizeErrors(result.errorRows);
                    categories[category].push(result.dbCode);
                }
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–¥—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
            Object.keys(categories).forEach(key => {
                categories[key].sort();
            });
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞
            let summaryText = '';
            
            if (categories.clean.length > 0) {
                summaryText += `–û—à–∏–±–æ–∫ –Ω–µ—Ç: ${categories.clean.join(', ')}\n`;
            }
            
            if (categories.ignore.length > 0) {
                summaryText += `–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å: ${categories.ignore.join(', ')}\n`;
            }
            
            if (categories.alerts.length > 0) {
                summaryText += `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –∞–ª–µ—Ä—Ç–æ–≤: ${categories.alerts.join(', ')}\n`;
            }
            
            if (summaryText === '') {
                summaryText = '–ù–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç—á—ë—Ç–∞';
            }
            
            return summaryText.trim();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copySummaryToClipboard() {
            const summaryText = document.getElementById('summaryText').textContent;
            navigator.clipboard.writeText(summaryText).then(() => {
                const button = document.querySelector('.copy-button');
                const originalText = button.textContent;
                button.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#3b82f6';
                }, 2000);
            }).catch(() => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è email
        let globalRecipients = new Set();
        let globalEmailData = null;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º –ø–æ–¥–ø–∏—Å–∏
        function saveSignatureToCache() {
            const signatureElement = document.getElementById('emailSignature');
            const signatureText = signatureElement.value;
            localStorage.setItem('emailSignature', signatureText);
        }

        function loadSignatureFromCache() {
            const cachedSignature = localStorage.getItem('emailSignature');
            const signatureElement = document.getElementById('emailSignature');
            
            if (cachedSignature) {
                signatureElement.value = cachedSignature;
            } else {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const defaultSignature = ``;
                signatureElement.value = defaultSignature;
                saveSignatureToCache();
            }
        }

        function getSignatureAsText() {
            const signatureElement = document.getElementById('emailSignature');
            return signatureElement.value || '';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏–∑ MSG —Ñ–∞–π–ª–æ–≤
        async function extractRecipientsFromFiles(files) {
            globalRecipients.clear();
            
            for (const file of files) {
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ email-parser.js
                    const recipients = await parseEmailRecipients(file);
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –í–°–ï–• –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏–∑ –≤—Å–µ—Ö –ø–æ–ª–µ–π
                    if (recipients.to && recipients.to.length > 0) {
                        recipients.to.forEach(email => globalRecipients.add(email));
                    }
                    if (recipients.cc && recipients.cc.length > 0) {
                        recipients.cc.forEach(email => globalRecipients.add(email));
                    }
                    if (recipients.bcc && recipients.bcc.length > 0) {
                        recipients.bcc.forEach(email => globalRecipients.add(email));
                    }
                    if (recipients.from && recipients.from.length > 0) {
                        recipients.from.forEach(email => globalRecipients.add(email));
                    }
                    if (recipients.replyTo && recipients.replyTo.length > 0) {
                        recipients.replyTo.forEach(email => globalRecipients.add(email));
                    }
                    if (recipients.other && recipients.other.length > 0) {
                        recipients.other.forEach(email => globalRecipients.add(email));
                    }
                    
                    console.log(`–§–∞–π–ª ${file.name}: TO=${recipients.to?.length || 0}, CC=${recipients.cc?.length || 0}, BCC=${recipients.bcc?.length || 0}, FROM=${recipients.from?.length || 0}, OTHER=${recipients.other?.length || 0}`);
                    
                } catch (error) {
                    console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏–∑ ${file.name}:`, error);
                    alertManager.warning(
                        '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π',
                        `–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏–∑ —Ñ–∞–π–ª–∞ ${file.name}`,
                        error.message
                    );
                }
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º email –∞–¥—Ä–µ—Å–∞
            const validRecipients = Array.from(globalRecipients)
                .filter(email => {
                    // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email
                    return email && 
                           typeof email === 'string' && 
                           email.includes('@') && 
                           email.length > 5 &&
                           email.length < 255 && // RFC –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                           !email.includes(' ') && // –ü—Ä–æ–±–µ–ª—ã –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã
                           !email.toLowerCase().endsWith('.su') && // –ò—Å–∫–ª—é—á–∞–µ–º –¥–æ–º–µ–Ω—ã .su
                           /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); // –ë–∞–∑–æ–≤—ã–π regex
                })
                .map(email => email.toLowerCase().trim())
                .sort();
            
            console.log(`–ò—Ç–æ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${validRecipients.length}`);
            console.log('–ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:', validRecipients.slice(0, 10));
            
            return validRecipients;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–∏—Å—å–º–∞
        function generateEmailData(results) {
            const now = new Date();
            
            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –¥–æ 8 —É—Ç—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
            const reportDate = now.getHours() < 8 
                ? new Date(now.getTime() - 24 * 60 * 60 * 1000) // –í—á–µ—Ä–∞
                : now; // –°–µ–≥–æ–¥–Ω—è
            
            const dateStr = reportDate.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
            
            const subject = `WMS –æ—à–∏–±–∫–∏ –∑–∞ —Å—É—Ç–∫–∏ –æ—Ç ${dateStr}`;
            const reportText = generateSummaryText(results);
            const signature = getSignatureAsText();
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Ç—á–µ—Ç –∏ –ø–æ–¥–ø–∏—Å—å
            const body = reportText + '\n\n' + signature;
            
            globalEmailData = {
                recipients: Array.from(globalRecipients).join('; '),
                subject: subject,
                body: body
            };
            
            return globalEmailData;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –ø–∏—Å—å–º–∞
        function updateEmailForm(emailData) {
            document.getElementById('emailRecipients').value = emailData.recipients || '–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
            document.getElementById('emailSubject').value = emailData.subject || '';
            document.getElementById('emailBody').value = emailData.body || '';
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            const sendButton = document.getElementById('sendEmailButton');
            if (emailData.recipients && emailData.subject && emailData.body) {
                sendButton.disabled = false;
            } else {
                sendButton.disabled = true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        function openEmailClient() {
            if (!globalEmailData) {
                alertManager.error('–û—à–∏–±–∫–∞', '–î–∞–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –Ω–µ –≥–æ—Ç–æ–≤—ã');
                return;
            }
            
            const mailto = `mailto:${encodeURIComponent(globalEmailData.recipients)}?subject=${encodeURIComponent(globalEmailData.subject)}&body=${encodeURIComponent(globalEmailData.body)}`;
            
            try {
                window.location.href = mailto;
            } catch (error) {
                alertManager.error('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—á—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç', error.message);
            }
        }

        document.getElementById('msgFiles').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            const reportsDiv = document.getElementById('reports');
            
            reportsDiv.innerHTML = '';
            
            // –ü–ï–†–í–´–ú –î–ï–õ–û–ú –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
            loadingGifManager.show();
            
            // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –≤—Ä–µ–º—è –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ —Ç—è–∂–µ–ª–æ–π —Ä–∞–±–æ—Ç–æ–π
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
            if (files.length !== 9) {
                const warningMsg = files.length < 9 
                    ? `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${files.length} —Ñ–∞–π–ª–æ–≤ –∏–∑ 9 –æ–∂–∏–¥–∞–µ–º—ã—Ö. –ù–µ–¥–æ—Å—Ç–∞–µ—Ç ${9 - files.length} —Ñ–∞–π–ª(–æ–≤).`
                    : `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${files.length} —Ñ–∞–π–ª–æ–≤, –æ–∂–∏–¥–∞–ª–æ—Å—å 9. –û–±—Ä–∞–±–æ—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 9 —Ñ–∞–π–ª–æ–≤.`;
                
                alertManager.warning('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤', warningMsg);
            }
            
            // –ï—â–µ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É
            await new Promise(resolve => setTimeout(resolve, 50));
            
            try {
                const startTime = performance.now();
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏–∑ –≤—Å–µ—Ö MSG —Ñ–∞–π–ª–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                console.log('–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏–∑ MSG —Ñ–∞–π–ª–æ–≤...');
                const recipients = await extractRecipientsFromFiles(files.slice(0, 9));
                console.log(`–ù–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${recipients.length}`);
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
                async function processFile(file, index) {
                    const fileStartTime = performance.now();
                    
                    try {
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ –±–∞–∑—ã –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–ø–µ—Ä–≤—ã–µ 4 —Ü–∏—Ñ—Ä—ã)
                        const dbCodeMatch = file.name.match(/^(\d{4})/);
                        const dbCode = dbCodeMatch ? dbCodeMatch[1] : 'XXXX';
                        
                        const arrayBuffer = await file.arrayBuffer();
                        const msgData = parseMSGFile(arrayBuffer);
                        
                        let result = {
                            fileName: file.name,
                            dbCode: dbCode,
                            fileSize: file.size,
                            processTime: 0,
                            status: 'error',
                            excelFound: false,
                            expectedErrors: 0,
                            foundErrors: 0,
                            errorRows: [],
                            rawData: null,
                            error: null
                        };
                        
                        if (msgData.attachments && msgData.attachments.length > 0) {
                            result.excelFound = true;
                            
                            for (let idx = 0; idx < msgData.attachments.length; idx++) {
                                const attachment = msgData.attachments[idx];
                                
                                try {
                                    const workbook = XLSX.read(attachment.content, {
                                        type: 'array',
                                        bookVBA: false,
                                        bookProps: false,
                                        cellStyles: false,
                                        cellDates: false
                                    });
                                    
                                    const sheetName = workbook.SheetNames[0];
                                    const sheet = workbook.Sheets[sheetName];
                                    const data = XLSX.utils.sheet_to_json(sheet, {
                                        header: 1, 
                                        blankrows: false
                                    });
                                    
                                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                                    const limitedData = data.slice(0, Math.min(data.length, 1000));
                                    result.rawData = limitedData;
                                    
                                    // –ü–æ–∏—Å–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—à–∏–±–æ–∫
                                    let errorsStart = -1;
                                    let expectedErrorCount = 0;
                                    let debugLog = [];
                                    
                                    for (let i = 0; i < Math.min(50, limitedData.length); i++) {
                                        const cell = limitedData[i][0];
                                        if (cell && typeof cell === 'string') {
                                            const cellText = cell.trim();
                                            const errorHeaderMatch = cellText.match(/^–û—à–∏–±–∫–∏\s*\((\d+)\)$/i);
                                            if (errorHeaderMatch) {
                                                errorsStart = i + 1;
                                                expectedErrorCount = parseInt(errorHeaderMatch[1]);
                                                result.expectedErrors = expectedErrorCount;
                                                debugLog.push(`–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—à–∏–±–æ–∫: R${i+1}C1 = "${cellText.substring(0,10)}..."`);
                                                break;
                                            }
                                        }
                                    }
                                    
                                    if (errorsStart === -1 && limitedData.length > 0) {
                                        alertManager.warning(
                                            '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω',
                                            `–í —Ñ–∞–π–ª–µ ${file.name} –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û—à–∏–±–∫–∏ (N)" –≤ –ø–µ—Ä–≤—ã—Ö 50 —Å—Ç—Ä–æ–∫–∞—Ö.`,
                                            `–ë–∞–∑–∞: ${dbCode} | –°—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö: ${limitedData.length}`
                                        );
                                    }
                                    
                                    // –ü–∞—Ä—Å–∏–Ω–≥ –æ—à–∏–±–æ–∫
                                    if (errorsStart > -1) {
                                        let currentErrorSum = 0;
                                        let errorRows = [];
                                        let errorsWithoutText = 0;
                                        const maxSearchRows = Math.min(errorsStart + 200, limitedData.length);
                                        
                                        for (let i = errorsStart; i < maxSearchRows; i++) {
                                            if (limitedData[i] && limitedData[i].length > 7) {
                                                const countText = limitedData[i][7];
                                                
                                                if (countText && !isNaN(parseInt(countText.toString()))) {
                                                    const errorCount = parseInt(countText.toString()) || 0;
                                                    
                                                    if (errorCount > 0) {
                                                        const errorText = limitedData[i][1];
                                                        const nodeInfo = limitedData[i][5] ? limitedData[i][5].toString().trim() : '';
                                                        
                                                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –ª–∏–±–æ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏, –ª–∏–±–æ —É–∑–µ–ª (–∏–ª–∏ –æ–±–∞)
                                                        const hasErrorText = errorText && errorText.toString().trim().length > 0;
                                                        const hasNodeInfo = nodeInfo.length > 0;
                                                        
                                                        if (hasErrorText || hasNodeInfo) {
                                                            currentErrorSum += errorCount;
                                                            
                                                            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—à–∏–±–∫–∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
                                                            if (!hasErrorText) {
                                                                errorsWithoutText++;
                                                            }
                                                            
                                                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ —É–∑–µ–ª –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
                                                            const mainText = hasErrorText ? errorText.toString().trim() : `[–£–∑–µ–ª: ${nodeInfo}]`;
                                                            
                                                            // –°–∂–∏–º–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                                            let shortText = mainText;
                                                            if (shortText.length > 150) {
                                                                shortText = shortText.substring(0, 150) + '...';
                                                            }
                                                            
                                                            errorRows.push({
                                                                row: i + 1,
                                                                text: mainText,
                                                                shortText: shortText,
                                                                node: nodeInfo,
                                                                count: errorCount
                                                            });
                                                            
                                                            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–≥ –æ—Ç–ª–∞–¥–∫–∏
                                                            const errorTextLog = hasErrorText ? errorText.toString().substring(0,10) : '[–Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞]';
                                                            debugLog.push(`–û—à–∏–±–∫–∞: R${i+1}C2="${errorTextLog}..." | R${i+1}C6="${nodeInfo.substring(0,10)}..." | R${i+1}C8="${errorCount}"`);
                                                            
                                                            if (currentErrorSum >= expectedErrorCount) {
                                                                break;
                                                            }
                                                        }
                                                    }
                                                } else {
                                                    const firstCell = limitedData[i][0];
                                                    if (firstCell && firstCell.toString().toLowerCase().includes('–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è')) {
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                        
                        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç—è—Ö
                        if (errorsWithoutText > 0) {
                            alertManager.warning(
                                '–û—à–∏–±–∫–∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞',
                                `–í —Ñ–∞–π–ª–µ ${file.name} –Ω–∞–π–¥–µ–Ω–æ ${errorsWithoutText} –æ—à–∏–±–æ–∫ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –æ–ø–∏—Å–∞–Ω–∏—è.`,
                                `–ë–∞–∑–∞: ${dbCode} | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏—è —É–∑–ª–æ–≤ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤ –æ—à–∏–±–æ–∫`
                            );
                        }
                        
                        if (currentErrorSum !== expectedErrorCount && expectedErrorCount > 0) {
                            alertManager.error(
                                '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫',
                                `–í —Ñ–∞–π–ª–µ ${file.name} –æ–∂–∏–¥–∞–ª–æ—Å—å ${expectedErrorCount} –æ—à–∏–±–æ–∫, –Ω–∞–π–¥–µ–Ω–æ ${currentErrorSum}.`,
                                `–ë–∞–∑–∞: ${dbCode} | –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–∫–∏ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ`
                            );
                        }                                        result.foundErrors = currentErrorSum;
                                        result.errorRows = errorRows;
                                        result.status = 'success';
                                        result.debugLog = debugLog;
                                    }
                                    
                                    break; // –ü–µ—Ä–≤—ã–π Excel —Ñ–∞–π–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
                                } catch (excelError) {
                                    result.error = `Excel –æ—à–∏–±–∫–∞: ${excelError.message}`;
                                    alertManager.error(
                                        '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel',
                                        `–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å Excel –∏–∑ —Ñ–∞–π–ª–∞ ${file.name}`,
                                        `–ë–∞–∑–∞: ${dbCode} | ${excelError.message}`
                                    );
                                }
                            }
                        } else {
                            result.error = 'Excel –≤–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ MSG —Ñ–∞–π–ª–µ';
                            alertManager.error(
                                'Excel –Ω–µ –Ω–∞–π–¥–µ–Ω',
                                `–í —Ñ–∞–π–ª–µ ${file.name} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ Excel –≤–ª–æ–∂–µ–Ω–∏–π.`,
                                `–ë–∞–∑–∞: ${dbCode} | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–∏—Å—å–º–æ —Å–æ–¥–µ—Ä–∂–∏—Ç .xlsx —Ñ–∞–π–ª`
                            );
                        }
                        
                        result.processTime = performance.now() - fileStartTime;
                        return result;
                        
                    } catch (error) {
                        const result = {
                            fileName: file.name,
                            dbCode: dbCodeMatch ? dbCodeMatch[1] : 'XXXX',
                            fileSize: file.size,
                            processTime: performance.now() - fileStartTime,
                            status: 'error',
                            error: error.message
                        };
                        
                        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞
                        alertManager.error(
                            '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞',
                            `–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª ${file.name}`,
                            `–ë–∞–∑–∞: ${result.dbCode} | ${error.message}`
                        );
                        
                        return result;
                    }
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                const processPromises = files.slice(0, 9).map((file, index) => processFile(file, index));
                const results = await Promise.all(processPromises);
                
                const totalTime = performance.now() - startTime;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞
                const emailData = generateEmailData(results);
                emailData.recipients = recipients.join('; ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø–∏—Å—å–º–∞
                updateEmailForm(emailData);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç
                generateMasterReport(results, totalTime);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–æ–Ω—É –∑–∞–≥—Ä—É–∑–∫–∏
                hideUploadZone();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≥–∏—Ñ–∫—É —Å—Ä–∞–∑—É
                loadingGifManager.hide();
            
                
            } catch (error) {
                alertManager.error(
                    '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞',
                    '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤',
                    error.message
                );
                
                reportsDiv.innerHTML = `<div class="file-block" style="border-color: #f00;">
                    <div style="color:#f00; font-size: 18px; margin-bottom: 15px;">‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
                    <div style="background: #ffe6e6; padding: 15px; border-radius: 5px;">${error.message}</div>
                </div>`;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≥–∏—Ñ–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                loadingGifManager.hide();
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        function generateMasterReport(results, totalTime) {
            const reportsDiv = document.getElementById('reports');
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
            const successful = results.filter(r => r.status === 'success');
            const failed = results.filter(r => r.status === 'error');
            const totalErrors = successful.reduce((sum, r) => sum + (r.foundErrors || 0), 0);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç
            const summaryText = generateSummaryText(results);
            
            // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const debugInfo = results
                .filter(r => r.debugLog && r.debugLog.length > 0)
                .map(r => `\n=== –ë–∞–∑–∞ ${r.dbCode} (${r.fileName}) ===\n${r.debugLog.join('\n')}`)
                .join('\n');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–≤–æ–¥–∫—É
            let masterReport = `
                <div class="file-block" style="background: linear-gradient(90deg,rgba(3, 23, 84, 0.31) 0%, rgba(6, 78, 92, 1) 100%);  margin-bottom: 20px; padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;">${results.length}</div>
                            <div style="font-size: 13px; opacity: 0.9;">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #4ade80;">${successful.length}</div>
                            <div style="font-size: 13px; opacity: 0.9;">–£—Å–ø–µ—à–Ω–æ</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #f87171;">${failed.length}</div>
                            <div style="font-size: 13px; opacity: 0.9;">–û—à–∏–±–æ–∫</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;">${(totalTime / 1000).toFixed(1)}—Å</div>
                            <div style="font-size: 13px; opacity: 0.9;">–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
                        </div>
                    </div>
                </div>
            `;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç—ã –ø–æ –∫–∞–∂–¥–æ–π –±–∞–∑–µ
            successful.forEach((result, index) => {
                const category = categorizeErrors(result.errorRows);
                const categoryInfo = getCategoryInfo(category);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—á—ë—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫
                const isErrorCountCorrect = result.foundErrors === result.expectedErrors;
                const errorCountColor = isErrorCountCorrect ? '#10b981' : '#ef4444'; // –ó–µ–ª—ë–Ω—ã–π –∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π
                const errorCountSize = isErrorCountCorrect ? '16px' : '14px';
                const errorCountShadow = isErrorCountCorrect ? 'box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);' : 'box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);';
                
                let errorsTable = '';
                if (result.errorRows && result.errorRows.length > 0) {
                    errorsTable = `
                        <table class="error-table">
                            <thead>
                                <tr>
                                    <th>–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏</th>
                                    <th>–£–∑–µ–ª</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    result.errorRows.forEach(err => {
                        const errorCategory = (err.node && (err.node.includes('–§–æ–Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ. –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è') || err.node.includes('–û–±–º–µ–Ω.'))) ? 'ignore' : 'alerts';
                        const errorCategoryInfo = getCategoryInfo(errorCategory);
                        
                        errorsTable += `
                            <tr>
                                <td class="error-text">${err.text || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                <td class="node-info">${err.node || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                <td class="count-cell">${err.count}</td>
                                <td><span class="category-indicator category-${errorCategory}">${errorCategoryInfo.label}</span></td>
                            </tr>
                        `;
                    });
                    
                    errorsTable += `
                            </tbody>
                        </table>
                    `;
                }
                
                masterReport += `
                    <div class="file-block" style="margin-bottom: 25px; border-left: 5px solid ${getDbColor(result.dbCode)};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: ${getDbColor(result.dbCode)};">
                                üè¢ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ${result.dbCode}
                            </h3>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: ${errorCountColor}; color: white; padding: 6px 16px; border-radius: 25px; font-size: ${errorCountSize}; font-weight: bold; ${errorCountShadow}">
                                    ${result.foundErrors}/${result.expectedErrors} –æ—à–∏–±–æ–∫
                                </span>
                                <span class="category-indicator category-${category}">${categoryInfo.label}</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; font-size: 14px;">
                            <div><strong>–§–∞–π–ª:</strong> ${result.fileName}</div>
                            <div><strong>–í—Ä–µ–º—è:</strong> ${result.processTime.toFixed(1)}ms</div>
                            <div><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: #10b981;">‚úÖ –£—Å–ø–µ—à–Ω–æ</span></div>
                        </div>
                        
                        ${result.errorRows && result.errorRows.length > 0 ? `
                            <div style="background: #2a1a1a; border: 1px solid #5a2a2a; border-radius: 8px; padding: 15px;">
                                <h4 style="margin: 0 0 15px 0; color: #ff6b6b;">üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (${categoryInfo.label}):</h4>
                                ${errorsTable}
                            </div>
                        ` : `
                            <div style="background: #1a2a1a; border: 1px solid #2a5a2a; border-radius: 8px; padding: 15px; color: #51cf66; text-align: center;">
                                ‚úÖ –û—à–∏–±–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã
                            </div>
                        `}
                    </div>
                `;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç—ã –ø–æ –Ω–µ—É–¥–∞—á–Ω—ã–º —Ñ–∞–π–ª–∞–º
            if (failed.length > 0) {
                masterReport += `<div class="file-block" style="border-left: 5px solid #ef4444; background: #2a1a1a;">
                    <h3 style="color: #ff6b6b; margin-bottom: 15px;">‚ùå –§–∞–π–ª—ã —Å –æ—à–∏–±–∫–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h3>`;
                
                failed.forEach(result => {
                    masterReport += `
                        <div style="background: #3a1a1a; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #5a2a2a;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #e5e5e5;">${result.fileName}</strong>
                                <span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                    –ë–∞–∑–∞: ${result.dbCode}
                                </span>
                            </div>
                            <div style="color: #ff6b6b; font-size: 14px; margin-bottom: 8px;">
                                <strong>–û—à–∏–±–∫–∞:</strong> ${result.error}
                            </div>
                            <div style="font-size: 12px; color: #c0c0c0;">
                                <strong>–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:</strong> ${(result.fileSize/1024).toFixed(1)} KB ‚Ä¢ 
                                <strong>–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:</strong> ${result.processTime.toFixed(1)}ms
                            </div>
                            ${result.error.includes('Excel –≤–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') ? `
                                <div style="background: #2a2a1a; border: 1px solid #4a4a2a; border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: #e5e5e5;">
                                    <strong>üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:</strong><br>
                                    ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–∏—Å—å–º–æ —Å–æ–¥–µ—Ä–∂–∏—Ç Excel –≤–ª–æ–∂–µ–Ω–∏–µ (.xlsx)<br>
                                    ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω<br>
                                    ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∏—Å—å–º–æ –∏–∑ Outlook<br>
                                    ‚Ä¢ –§–∞–π–ª—ã .xls (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                masterReport += `</div>`;
            }
            
            reportsDiv.innerHTML = masterReport;
            
            // –í—ã–≤–æ–¥–∏–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞
            if (debugInfo.trim().length > 0) {
                console.log('\nüîç –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø - –ù–ê–ô–î–ï–ù–ù–´–ï –Ø–ß–ï–ô–ö–ò:');
                console.log(debugInfo);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function getCategoryInfo(category) {
            const categoryMap = {
                'clean': { label: '–ë–µ–∑ –æ—à–∏–±–æ–∫', color: '#16a34a' },
                'ignore': { label: '–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å', color: '#d97706' },
                'alerts': { label: '–ê–ª–µ—Ä—Ç—ã', color: '#dc2626' }
            };
            return categoryMap[category] || { label: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', color: '#6b7280' };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        function getDbColor(dbCode) {
            const colors = {
                '5011': '#3b82f6', // –°–∏–Ω–∏–π
                '5015': '#10b981', // –ó–µ–ª–µ–Ω—ã–π
                '5001': '#f59e0b', // –ñ–µ–ª—Ç—ã–π
                '5005': '#ef4444', // –ö—Ä–∞—Å–Ω—ã–π
                '5010': '#8b5cf6', // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
                '5020': '#06b6d4', // –ì–æ–ª—É–±–æ–π
                '5025': '#84cc16', // –õ–∞–π–º
                '5030': '#f97316', // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                '5035': '#ec4899'  // –†–æ–∑–æ–≤—ã–π
            };
            return colors[dbCode] || '#6b7280'; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ drag & drop
        const dropZone = document.getElementById('dropZone');
        const msgFiles = document.getElementById('msgFiles');
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ drag & drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã—à—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∏–Ω—É–ª–∞ –∑–æ–Ω—É
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            const msgFiles = files.filter(file => file.name.toLowerCase().endsWith('.msg'));
            
            if (msgFiles.length > 0) {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FileList –æ–±—ä–µ–∫—Ç
                const dt = new DataTransfer();
                msgFiles.forEach(file => dt.items.add(file));
                document.getElementById('msgFiles').files = dt.files;
                document.getElementById('msgFiles').dispatchEvent(new Event('change'));
            } else {
                alertManager.warning(
                    '–ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ñ–∞–π–ª—ã',
                    '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–æ–ª—å–∫–æ MSG —Ñ–∞–π–ª—ã.',
                    `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${files.length}, MSG —Ñ–∞–π–ª–æ–≤: ${msgFiles.length}`
                );
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∑–æ–Ω—ã –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        function hideUploadZone() {
            const uploadPanel = document.getElementById('uploadPanel');
            const mainContent = document.getElementById('mainContent');
            
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–±–∏—Ä–∞–µ–º –ø–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ DOM
            uploadPanel.remove();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            mainContent.classList.remove('upload-mode');
            mainContent.classList.add('report-mode');
        }
    </script>
</body>
</html>
